<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>üì±üìù Radiant Life - Next Gen Social App</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #23272a 0%, #5865f2 100%);
            color: #fff;
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        header {
            background: #23272a;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        header h1 {
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        nav {
            display: flex;
            gap: 1.5em;
        }
        nav a {
            color: #fff;
            text-decoration: none;
            font-weight: 700;
            transition: color 0.2s;
            cursor: pointer;
        }
        nav a:hover {
            color: #5865f2;
        }
        main {
            display: flex;
            height: calc(100vh - 70px);
        }
        .sidebar {
            width: 260px;
            background: #2c2f33;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border-right: 1px solid #23272a;
        }
        .sidebar h2 {
            font-size: 1.1rem;
            margin: 0 0 0.5em 0.5em;
            color: #b9bbbe;
        }
        .server-list, .channel-list, .friend-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }
        .server-list li, .channel-list li, .friend-list li {
            padding: 0.5em 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .server-list li:hover, .channel-list li:hover, .friend-list li:hover {
            background: #40444b;
        }
        .add-btn {
            background: #5865f2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.2em 0.6em;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 0.5em;
        }
        .profile {
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 0.7em;
            padding: 0.7em 1em;
            background: #23272a;
            border-radius: 8px;
        }
        .profile img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #5865f2;
        }
        .profile-info {
            flex: 1;
        }
        .profile-info span {
            display: block;
            font-size: 0.95em;
            font-weight: 700;
        }
        .profile-status {
            font-size: 0.8em;
            color: #43b581;
        }
        .profile-bio {
            font-size: 0.85em;
            color: #b9bbbe;
            margin-top: 0.2em;
        }
        .profile-customize-btn {
            background: #5865f2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.3em 0.7em;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 0.5em;
        }
        .logout-btn {
            background: #ff5555;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.3em 0.7em;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 0.5em;
        }
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(44,47,51,0.95);
        }
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #23272a;
            display: flex;
            align-items: center;
            gap: 1em;
            background: #23272a;
        }
        .chat-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5em 2em;
            display: flex;
            flex-direction: column;
            gap: 1em;
        }
        .message {
            display: flex;
            align-items: flex-start;
            gap: 1em;
        }
        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #5865f2;
        }
        .message-content {
            background: #40444b;
            padding: 0.8em 1.2em;
            border-radius: 12px;
            max-width: 60vw;
            position: relative;
        }
        .message-content .meta {
            font-size: 0.8em;
            color: #b9bbbe;
            margin-bottom: 0.2em;
        }
        .message-content .text {
            font-size: 1em;
            color: #fff;
        }
        .chat-input-section {
            padding: 1em 2em;
            border-top: 1px solid #23272a;
            background: #23272a;
            display: flex;
            align-items: center;
            gap: 1em;
        }
        .chat-input-section input[type="text"] {
            flex: 1;
            padding: 0.8em 1em;
            border-radius: 8px;
            border: none;
            font-size: 1em;
            background: #40444b;
            color: #fff;
            outline: none;
        }
        .chat-input-section button {
            background: #5865f2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.8em 1.5em;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-input-section button:hover {
            background: #4752c4;
        }
        /* Modal styles */
        .modal-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #23272a;
            padding: 2em 2em 1em 2em;
            border-radius: 12px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 4px 32px rgba(0,0,0,0.4);
        }
        .modal h2 {
            margin-top: 0;
            color: #fff;
        }
        .modal label {
            display: block;
            margin: 1em 0 0.3em 0;
            color: #b9bbbe;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 0.7em;
            border-radius: 6px;
            border: none;
            margin-bottom: 1em;
            background: #40444b;
            color: #fff;
            font-size: 1em;
        }
        .modal textarea {
            min-height: 60px;
            resize: vertical;
        }
        .modal button {
            background: #5865f2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7em 1.5em;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            margin-right: 0.5em;
        }
        .modal .close-btn {
            background: #ff5555;
        }
        .modal .switch-link {
            background: none;
            color: #5865f2;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.95em;
            margin-top: 0.5em;
        }
        /* Video call styles */
        .video-call-modal {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .video-container {
            display: flex;
            gap: 1em;
            margin-bottom: 1em;
        }
        video {
            width: 220px;
            height: 160px;
            background: #000;
            border-radius: 8px;
        }
        .video-call-controls button {
            background: #43b581;
            margin-right: 0.5em;
        }
        .video-call-controls .end-btn {
            background: #ff5555;
        }
        /* Responsive */
        @media (max-width: 900px) {
            main {
                flex-direction: column;
            }
            .sidebar {
                width: 100vw;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid #23272a;
            }
            .chat-section {
                min-height: 60vh;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Modal -->
    <div class="modal-bg" id="auth-modal">
        <div class="modal" id="login-modal">
            <h2>Login</h2>
            <form id="login-form" autocomplete="off">
                <label for="login-username">Username</label>
                <input type="text" id="login-username" required>
                <label for="login-password">Password</label>
                <input type="password" id="login-password" required>
                <button type="submit">Login</button>
                <button type="button" class="switch-link" id="show-register">Create Account</button>
            </form>
        </div>
        <div class="modal hidden" id="register-modal">
            <h2>Register</h2>
            <form id="register-form" autocomplete="off">
                <label for="register-username">Username</label>
                <input type="text" id="register-username" required>
                <label for="register-password">Password</label>
                <input type="password" id="register-password" required>
                <label for="register-avatar">Avatar URL</label>
                <input type="url" id="register-avatar" placeholder="https://...">
                <label for="register-bio">Bio</label>
                <textarea id="register-bio" maxlength="120" placeholder="Tell us about yourself..."></textarea>
                <button type="submit">Register</button>
                <button type="button" class="switch-link" id="show-login">Back to Login</button>
            </form>
        </div>
    </div>
    <!-- Profile Customizer Modal -->
    <div class="modal-bg hidden" id="profile-modal">
        <div class="modal">
            <h2>Customize Profile</h2>
            <form id="profile-form" autocomplete="off">
                <label for="profile-username">Username</label>
                <input type="text" id="profile-username" disabled>
                <label for="profile-avatar">Avatar URL</label>
                <input type="url" id="profile-avatar">
                <label for="profile-status">Status</label>
                <select id="profile-status">
                    <option value="Online">Online</option>
                    <option value="Away">Away</option>
                    <option value="Busy">Busy</option>
                    <option value="Offline">Offline</option>
                </select>
                <label for="profile-bio">Bio</label>
                <textarea id="profile-bio" maxlength="120"></textarea>
                <button type="submit">Save</button>
                <button type="button" class="close-btn" id="close-profile-modal">Cancel</button>
            </form>
        </div>
    </div>
    <!-- Video Call Modal -->
    <div class="modal-bg hidden" id="video-call-modal">
        <div class="modal video-call-modal">
            <h2>Video Call</h2>
            <div class="video-container">
                <video id="localVideo" autoplay muted></video>
                <video id="remoteVideo" autoplay></video>
            </div>
            <div class="video-call-controls">
                <button id="end-call-btn" class="end-btn">End Call</button>
            </div>
        </div>
    </div>
    <header>
        <h1>üì±üìù Radiant Life</h1>
        <nav>
            <a href="#" id="nav-chats">Chats</a>
            <a href="#" id="nav-servers">Servers</a>
            <a href="#" id="nav-games">Games</a>
            <a href="#" id="nav-profile">Profile</a>
            <a href="#" id="nav-settings">Settings</a>
        </nav>
    </header>
    <main>
        <aside class="sidebar">
            <div>
                <h2>Servers <button id="add-server-btn" class="add-btn">+</button></h2>
                <ul class="server-list" id="server-list">
                    <!-- Servers will be rendered here -->
                </ul>
            </div>
            <div>
                <h2>Channels <button id="add-channel-btn" class="add-btn">+</button></h2>
                <ul class="channel-list" id="channel-list">
                    <!-- Channels will be rendered here -->
                </ul>
            </div>
            <div>
                <h2>Friends <button id="add-friend-btn" class="add-btn">+</button></h2>
                <ul class="friend-list" id="friend-list">
                    <!-- Friends will be rendered here -->
                </ul>
            </div>
            <div class="profile" id="sidebar-profile">
                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile" id="sidebar-avatar">
                <div class="profile-info">
                    <span id="sidebar-username">JohnDoe</span>
                    <span class="profile-status" id="sidebar-status">Online</span>
                    <span class="profile-bio" id="sidebar-bio"></span>
                </div>
                <button class="profile-customize-btn" id="customize-profile-btn">Edit</button>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
        </aside>
        <section class="chat-section">
            <div class="chat-header">
                <h2 id="chat-title"># general-chat</h2>
                <span id="online-count">1 online</span>
                <button id="video-call-btn" style="margin-left:auto;background:#43b581;color:#fff;border:none;border-radius:6px;padding:0.4em 1em;font-size:1em;cursor:pointer;">Video Call</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- Messages will be rendered here -->
            </div>
            <form class="chat-input-section" id="chat-form" autocomplete="off">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button type="submit">Send</button>
            </form>
        </section>
        <!-- Personal Chat Section (hidden by default) -->
        <section class="chat-section hidden" id="personal-chat-section">
            <div class="chat-header">
                <h2 id="personal-chat-title">@ Friend</h2>
                <button id="personal-video-call-btn" style="margin-left:auto;background:#43b581;color:#fff;border:none;border-radius:6px;padding:0.4em 1em;font-size:1em;cursor:pointer;">Video Call</button>
            </div>
            <div class="chat-messages" id="personal-chat-messages"></div>
            <form class="chat-input-section" id="personal-chat-form" autocomplete="off">
                <input type="text" id="personal-chat-input" placeholder="Type your message...">
                <button type="submit">Send</button>
            </form>
        </section>
    </main>
    <!-- Add Friend Modal -->
    <div class="modal-bg hidden" id="add-friend-modal">
        <div class="modal">
            <h2>Add Friend</h2>
            <form id="add-friend-form" autocomplete="off">
                <label for="friend-username">Friend's Username</label>
                <input type="text" id="friend-username" required>
                <button type="submit">Add</button>
                <button type="button" class="close-btn" id="close-add-friend-modal">Cancel</button>
            </form>
        </div>
    </div>
    <!-- Add Server Modal -->
    <div class="modal-bg hidden" id="add-server-modal">
        <div class="modal">
            <h2>Add Server</h2>
            <form id="add-server-form" autocomplete="off">
                <label for="server-name">Server Name</label>
                <input type="text" id="server-name" required maxlength="24">
                <button type="submit">Add</button>
                <button type="button" class="close-btn" id="close-add-server-modal">Cancel</button>
            </form>
        </div>
    </div>
    <!-- Add Channel Modal -->
    <div class="modal-bg hidden" id="add-channel-modal">
        <div class="modal">
            <h2>Add Channel</h2>
            <form id="add-channel-form" autocomplete="off">
                <label for="channel-name">Channel Name</label>
                <input type="text" id="channel-name" required maxlength="24">
                <button type="submit">Add</button>
                <button type="button" class="close-btn" id="close-add-channel-modal">Cancel</button>
            </form>
        </div>
    </div>
    <script>
    // --- Simple Local Storage User System ---
    const defaultAvatar = "https://randomuser.me/api/portraits/men/32.jpg";
    const defaultStatus = "Online";
    const defaultBio = "";
    const defaultFriends = [];
    const defaultServers = ["üåü General"];
    const defaultChannels = ["# general-chat"];
    const defaultMessages = [
        { username: "JohnDoe", avatar: defaultAvatar, time: "10:02", text: "Welcome to your new server!" }
    ];

    // --- Auth Modal Logic ---
    const authModal = document.getElementById('auth-modal');
    const loginModal = document.getElementById('login-modal');
    const registerModal = document.getElementById('register-modal');
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');

    function showLoginModal() {
        loginModal.classList.remove('hidden');
        registerModal.classList.add('hidden');
        authModal.classList.remove('hidden');
    }
    function showRegisterModal() {
        loginModal.classList.add('hidden');
        registerModal.classList.remove('hidden');
        authModal.classList.remove('hidden');
    }
    showRegister.onclick = showRegisterModal;
    showLogin.onclick = showLoginModal;

    // --- User State ---
    function getUsers() {
        return JSON.parse(localStorage.getItem('users') || '{}');
    }
    function setUsers(users) {
        localStorage.setItem('users', JSON.stringify(users));
    }
    function saveSession(username) {
        localStorage.setItem('session', username);
    }
    function getSession() {
        return localStorage.getItem('session');
    }
    function clearSession() {
        localStorage.removeItem('session');
    }
    function getUserData(username) {
        const users = getUsers();
        return users[username];
    }
    function setUserData(username, data) {
        const users = getUsers();
        users[username] = data;
        setUsers(users);
    }

    // --- Login/Register Handlers ---
    loginForm.onsubmit = function(e) {
        e.preventDefault();
        const username = loginForm['login-username'].value.trim();
        const password = loginForm['login-password'].value;
        const users = getUsers();
        if (users[username] && users[username].password === password) {
            saveSession(username);
            authModal.classList.add('hidden');
            loadUser();
        } else {
            alert('Invalid username or password!');
        }
    };
    registerForm.onsubmit = function(e) {
        e.preventDefault();
        const username = registerForm['register-username'].value.trim();
        const password = registerForm['register-password'].value;
        const avatar = registerForm['register-avatar'].value.trim() || defaultAvatar;
        const bio = registerForm['register-bio'].value.trim().slice(0,120) || defaultBio;
        if (!username || !password) return;
        const users = getUsers();
        if (users[username]) {
            alert('Username already exists!');
            return;
        }
        users[username] = {
            password,
            avatar,
            status: defaultStatus,
            bio,
            friends: defaultFriends,
            servers: [...defaultServers],
            channels: [...defaultChannels],
            messages: [...defaultMessages],
            personalChats: {}
        };
        setUsers(users);
        saveSession(username);
        authModal.classList.add('hidden');
        loadUser();
    };

    // --- Profile Customizer ---
    const profileModal = document.getElementById('profile-modal');
    const profileForm = document.getElementById('profile-form');
    const closeProfileModal = document.getElementById('close-profile-modal');
    document.getElementById('customize-profile-btn').onclick = function() {
        const user = getUserData(getSession());
        profileForm['profile-username'].value = getSession();
        profileForm['profile-avatar'].value = user.avatar || defaultAvatar;
        profileForm['profile-status'].value = user.status || defaultStatus;
        profileForm['profile-bio'].value = user.bio || "";
        profileModal.classList.remove('hidden');
    };
    closeProfileModal.onclick = () => profileModal.classList.add('hidden');
    profileForm.onsubmit = function(e) {
        e.preventDefault();
        const username = getSession();
        const user = getUserData(username);
        user.avatar = profileForm['profile-avatar'].value.trim() || defaultAvatar;
        user.status = profileForm['profile-status'].value;
        user.bio = profileForm['profile-bio'].value.trim().slice(0,120);
        setUserData(username, user);
        renderSidebarProfile();
        profileModal.classList.add('hidden');
    };

    // --- Sidebar Profile Render ---
    function renderSidebarProfile() {
        const username = getSession();
        const user = getUserData(username);
        document.getElementById('sidebar-avatar').src = user.avatar || defaultAvatar;
        document.getElementById('sidebar-username').textContent = username;
        document.getElementById('sidebar-status').textContent = user.status || defaultStatus;
        document.getElementById('sidebar-status').style.color =
            user.status === "Online" ? "#43b581" :
            user.status === "Away" ? "#faa61a" :
            user.status === "Busy" ? "#ff5555" : "#b9bbbe";
        document.getElementById('sidebar-bio').textContent = user.bio || "";
    }

    // --- Logout ---
    document.getElementById('logout-btn').onclick = function() {
        clearSession();
        showLoginModal();
    };

    // --- Friends List ---
    function renderFriends() {
        const username = getSession();
        const user = getUserData(username);
        const friendList = document.getElementById('friend-list');
        friendList.innerHTML = '';
        (user.friends || []).forEach(friend => {
            const li = document.createElement('li');
            li.innerHTML = `${friend.status === "Online" ? "üü¢" : friend.status === "Away" ? "üü°" : "üî¥"} <span style="font-weight:700;cursor:pointer">${friend.username}</span>`;
            li.onclick = () => openPersonalChat(friend.username);
            friendList.appendChild(li);
        });
    }

    // --- Add Friend Modal ---
    const addFriendModal = document.getElementById('add-friend-modal');
    document.getElementById('add-friend-btn').onclick = () => addFriendModal.classList.remove('hidden');
    document.getElementById('close-add-friend-modal').onclick = () => addFriendModal.classList.add('hidden');
    document.getElementById('add-friend-form').onsubmit = function(e) {
        e.preventDefault();
        const username = getSession();
        const user = getUserData(username);
        const friendUsername = document.getElementById('friend-username').value.trim();
        if (!friendUsername || friendUsername === username) return;
        const users = getUsers();
        if (!users[friendUsername]) {
            alert("User not found!");
            return;
        }
        if (user.friends.some(f => f.username === friendUsername)) {
            alert("Already friends!");
            return;
        }
        user.friends.push({
            username: friendUsername,
            avatar: users[friendUsername].avatar || defaultAvatar,
            status: users[friendUsername].status || defaultStatus
        });
        setUserData(username, user);
        renderFriends();
        addFriendModal.classList.add('hidden');
    };

    // --- Servers ---
    function renderServers() {
        const username = getSession();
        const user = getUserData(username);
        const serverList = document.getElementById('server-list');
        serverList.innerHTML = '';
        (user.servers || []).forEach(server => {
            const li = document.createElement('li');
            li.textContent = server;
            li.onclick = () => selectServer(server);
            serverList.appendChild(li);
        });
    }
    // Add Server Modal
    const addServerModal = document.getElementById('add-server-modal');
    document.getElementById('add-server-btn').onclick = () => addServerModal.classList.remove('hidden');
    document.getElementById('close-add-server-modal').onclick = () => addServerModal.classList.add('hidden');
    document.getElementById('add-server-form').onsubmit = function(e) {
        e.preventDefault();
        const username = getSession();
        const user = getUserData(username);
        const serverName = document.getElementById('server-name').value.trim().slice(0,24);
        if (!serverName) return;
        if (user.servers.includes(serverName)) {
            alert("Server already exists!");
            return;
        }
        user.servers.push(serverName);
        setUserData(username, user);
        renderServers();
        addServerModal.classList.add('hidden');
    };

    // --- Channels ---
    function renderChannels() {
        const username = getSession();
        const user = getUserData(username);
        const channelList = document.getElementById('channel-list');
        channelList.innerHTML = '';
        (user.channels || []).forEach(channel => {
            const li = document.createElement('li');
            li.textContent = channel;
            li.onclick = () => selectChannel(channel);
            channelList.appendChild(li);
        });
    }
    // Add Channel Modal
    const addChannelModal = document.getElementById('add-channel-modal');
    document.getElementById('add-channel-btn').onclick = () => addChannelModal.classList.remove('hidden');
    document.getElementById('close-add-channel-modal').onclick = () => addChannelModal.classList.add('hidden');
    document.getElementById('add-channel-form').onsubmit = function(e) {
        e.preventDefault();
        const username = getSession();
        const user = getUserData(username);
        let channelName = document.getElementById('channel-name').value.trim().slice(0,24);
        if (!channelName.startsWith("#")) channelName = "# " + channelName;
        if (user.channels.includes(channelName)) {
            alert("Channel already exists!");
            return;
        }
        user.channels.push(channelName);
        setUserData(username, user);
        renderChannels();
        addChannelModal.classList.add('hidden');
    };

    // --- Chat Messages ---
    let currentServer = null;
    let currentChannel = null;
    function selectServer(server) {
        currentServer = server;
        // For demo, just update title
        document.getElementById('chat-title').textContent = server;
    }
    function selectChannel(channel) {
        currentChannel = channel;
        document.getElementById('chat-title').textContent = channel;
        renderMessages();
    }
    function renderMessages() {
        const username = getSession();
        const user = getUserData(username);
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';
        (user.messages || []).forEach(msg => {
            chatMessages.appendChild(createMessageDiv(msg));
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function createMessageDiv(msg) {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `
            <img class="avatar" src="${msg.avatar}" alt="User">
            <div class="message-content">
                <div class="meta">${msg.username} ‚Ä¢ ${msg.time}</div>
                <div class="text">${msg.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
            </div>
        `;
        return div;
    }

    // --- Chat Form Handler ---
    document.getElementById('chat-form').onsubmit = function(e) {
        e.preventDefault();
        const username = getSession();
        const user = getUserData(username);
        const chatInput = document.getElementById('chat-input');
        const text = chatInput.value.trim();
        if (!text) return;
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        const msg = {
            username,
            avatar: user.avatar || defaultAvatar,
            time,
            text
        };
        user.messages = user.messages || [];
        user.messages.push(msg);
        setUserData(username, user);
        renderMessages();
        chatInput.value = '';
    };

    // --- Personal Chat Logic ---
    let currentPersonalChat = null;
    function openPersonalChat(friendUsername) {
        currentPersonalChat = friendUsername;
        document.querySelector('.chat-section').classList.add('hidden');
        document.getElementById('personal-chat-section').classList.remove('hidden');
        document.getElementById('personal-chat-title').textContent = '@ ' + friendUsername;
        renderPersonalChatMessages();
    }
    function renderPersonalChatMessages() {
        const username = getSession();
        const user = getUserData(username);
        const chatKey = [username, currentPersonalChat].sort().join('-');
        user.personalChats = user.personalChats || {};
        const messages = user.personalChats[chatKey] || [];
        const chatMessages = document.getElementById('personal-chat-messages');
        chatMessages.innerHTML = '';
        messages.forEach(msg => {
            chatMessages.appendChild(createMessageDiv(msg));
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    document.getElementById('personal-chat-form').onsubmit = function(e) {
        e.preventDefault();
        const username = getSession();
        const user = getUserData(username);
        const chatInput = document.getElementById('personal-chat-input');
        const text = chatInput.value.trim();
        if (!text) return;
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        const msg = {
            username,
            avatar: user.avatar || defaultAvatar,
            time,
            text
        };
        const chatKey = [username, currentPersonalChat].sort().join('-');
        user.personalChats = user.personalChats || {};
        user.personalChats[chatKey] = user.personalChats[chatKey] || [];
        user.personalChats[chatKey].push(msg);
        setUserData(username, user);
        renderPersonalChatMessages();
        chatInput.value = '';
    };
    // Back to main chat when clicking "Chats" nav
    document.getElementById('nav-chats').onclick = function() {
        document.querySelector('.chat-section').classList.remove('hidden');
        document.getElementById('personal-chat-section').classList.add('hidden');
        currentPersonalChat = null;
    };

    // --- Video Call (WebRTC local demo) ---
    let localStream = null;
    let remoteStream = null;
    let videoCallActive = false;
    const videoCallModal = document.getElementById('video-call-modal');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    function startVideoCall() {
        videoCallModal.classList.remove('hidden');
        if (!videoCallActive) {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    localVideo.srcObject = stream;
                    // For demo, just mirror local stream to remote
                    remoteVideo.srcObject = stream;
                    videoCallActive = true;
                }).catch(() => {
                    alert("Could not access camera/mic.");
                    videoCallModal.classList.add('hidden');
                });
        }
    }
    function endVideoCall() {
        videoCallModal.classList.add('hidden');
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        videoCallActive = false;
    }
    document.getElementById('video-call-btn').onclick = startVideoCall;
    document.getElementById('personal-video-call-btn').onclick = startVideoCall;
    document.getElementById('end-call-btn').onclick = endVideoCall;

    // --- Load User Data on Login ---
    function loadUser() {
        renderSidebarProfile();
        renderFriends();
        renderServers();
        renderChannels();
        renderMessages();
        document.getElementById('chat-input').value = '';
        document.getElementById('personal-chat-input').value = '';
        document.querySelector('.chat-section').classList.remove('hidden');
        document.getElementById('personal-chat-section').classList.add('hidden');
    }

    // --- Session Persistence ---
    window.onload = function() {
        if (getSession() && getUserData(getSession())) {
            authModal.classList.add('hidden');
            loadUser();
        } else {
            showLoginModal();
        }
    };
    </script>
</body>
</html>
